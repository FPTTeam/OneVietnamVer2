
@using MongoDB.Driver.Linq
@using OneVietnam.DTL;
@using Microsoft.AspNet.Identity

@model OneVietnam.Models.PostViewModel
@{
    ViewBag.Tiltel = "EditPost";
    List<Tag> tagList = ViewData["TagList"] as List<Tag>;
    List<Icon> postTypes = ViewData["PostTypes"] as List<Icon>;

}
@if (Request.IsAuthenticated)
{
    <script>
        isAuthenticated = true;

        $.ajax({
            url: '/Map/GetUserInfo?userId=' + "@User.Identity.GetUserId()",
            type: 'GET',
            contentType: 'application/json;',
            dataType: 'json',
            success: function (json) {
                authenticatedUser = {x:json.Location.XCoordinate,y:json.Location.YCoordinate,address:json.Location.Address};
            }
        });
    </script>
}
<script src="~/Scripts/jquery-1.10.2.js"></script>

<div style="margin: auto; width: 40%">
    @using (Html.BeginForm("EditPost", "Post", FormMethod.Post))
    {

        if (Model != null && (Model.DeletedFlag == false) && (Model.LockedFlag == false))
        {
            @Html.AntiForgeryToken()
            @Html.ValidationSummary(true, "", new { @class = "text-danger" })
            <div class="ui segments" style="width: 100%; border: 0 !important;">

                @*Title area *@
                <div class="ui segment" style="width: 100%; border: 0 !important;">
                    <div class="ui left icon big input" style="width: 100%;">
                        <input id="Title" name="Title" placeholder="Nhập tiêu đề" type="text" value="@Model.Title">
                        <i class="star icon"></i>
                    </div>
                </div>

                @*Illustration Area*@
            <div class="ui segment" style="width: 100%; border: 0 !important; padding-top: 0">
                @*<div class="dropzone" id="myId">
                        <div class="fallback">
                            <input id="files" multiple="" name="files" type="file">
                        </div>
                    </div>*@
                
                
            </div>
                

                @*Post Status*@
                <div class="ui segment" style="width: 100%; border: 0 !important; padding-top: 0">
                    <div class="ui toggle checkbox">
                        <input data-val="true" checked="@Model.Status" id="Status" name="Status" type="checkbox" value="true" onchange="ChangeStatus()" />
                        <input name="Status" type="hidden" value="@Model.Status" />
                        @if (Model.Status)
                        {
                        <label id="LblStatus">Đóng bài đăng</label>
                        }
                        else
                        {
                        <label id="LblStatus">Mở bài đăng</label>
                        }
                    </div>
                    <script>
                        function ChangeStatus() {
                            var chkStt = document.getElementById("Status");
                            var lblStt = document.getElementById("LblStatus");
                            if (chkStt.checked) {
                                lblStt.innerText = "Đóng bài đăng";
                            } else {
                                lblStt.innerText = "Mở bài đăng";
                            }
                        };
                    </script>
                </div>

                @*Post Type*@
                <div class="ui segment" style="width: 100%; border: 0 !important; padding-top: 0">
                    <div class="ui selection dropdown" id="drPostType" style="width: 100%; min-width: 100%">
                        <i class="filter icon"></i>
                        <input type="hidden" id="PostType" name="PostType" value="@Model.PostType">
                        <i class="dropdown icon"></i>
                        <div class="default text">Chọn loại bài đăng</div>
                        <div class="menu">
                            @{
                                if (postTypes != null)
                                {
                                    foreach (Icon icon in postTypes)
                                    {
                            <div class="item" data-value="@icon.IconId">
                                @icon.IconText
                            </div>
                                    }
                                }
                            }

                        </div>
                    </div>

                </div>

                @*Address*@
                <div class="ui segment" style="width: 100%; border: 0 !important; padding-top: 0">
                   
                        <label>* Địa chỉ liên hệ</label>
                        <div class="ui floating labeled icon dropdown button" id="locationDr" style="float: left">
                            <i class="blue world icon"></i>
                            <span class="text"> Địa chỉ nhà của bạn</span>
                            <div class="menu">
                                <div class="item" onclick="getRegisteredLocation();" id="getloc">
                                    <div class="ui red empty circular label"></div>
                                    Địa chỉ nhà của bạn
                                </div>
                                <div class="item" onclick="getCurrentLocation();"  >
                                    <div class="ui blue empty circular label"></div>
                                    Địa điểm hiện tại của bạn
                                </div>

                                <div class="divider"></div>

                                <div class="header">
                                    Tìm kiếm địa điểm khác
                                </div>
                                <div class="ui left icon input">
                                    <i class="search icon"></i>
                                    <input type="text" id="search-location2" name="search" placeholder="Tìm kiếm địa điểm...">
                                </div>
                            </div>
                        </div>
                    <div class="ui fluid input">
                        @Html.TextBoxFor(model => model.PostLocation.Address, new { id = "Address_Edit" })
                    </div>
                        @Html.TextBoxFor(model => model.PostLocation.XCoordinate , htmlAttributes: new { style = "display: none", id = "XCoordinate_Edit" })
                        @Html.TextBoxFor(model => model.PostLocation.YCoordinate,  htmlAttributes : new { style = "display: none" , id = "YCoordinate_Edit" } )

                   

                </div>

                @*Description Area*@
                <div class="ui segment" style="width: 100%; border: 0 !important; padding-top: 0">
                    <textarea id="Description" name="Description" onkeydown="setHeight('Description')" onkeyup="setHeight('Description')" style="text-align: justify; width: 100%; max-width: 100%;">@Model.Description</textarea>
                    <script type="text/javascript">
                        function setHeight(fieldId) {
                            document
                                .getElementById(fieldId)
                                .style.height = document.getElementById(fieldId).scrollHeight + 'px';
                        }

                        setHeight('Description');
                    </script>
                </div>

                @*Related Tags*@
                <div class="ui segment" style="width: 100%; border: 0 !important; padding-top: 0">
                    <div class="ui fluid multiple search selection dropdown">
                        @{
                            string tagValue = "";
                            if (Model.Tags != null)
                            {
                                foreach (var tag in Model.Tags)
                                {
                                    tagValue = string.IsNullOrEmpty(tagValue) ? tag.TagValue : string.Concat(tagValue + ",", tag.TagValue);
                                }
                            }

                        }
                        <input name="TagsInput" id="TagsInput" type="hidden" value="@tagValue">
                        <i class="tags icon"></i>
                        <input class="search" autocomplete="off" tabindex="0"><span class="sizer"></span>
                        <div class="default text" style="padding-left: 1.5rem">Thẻ liên quan</div>
                        <div class="menu transition hidden" tabindex="-1">

                            @{
                                if (tagList != null)
                                {
                                    foreach (Tag tag in tagList)
                                    {
                            <div class="item" data-value="@tag.TagValue">@tag.TagText</div>
                                    }
                                }
                            }

                        </div>
                    </div>
                </div>

                @*Button Save and Cancel*@
                <div class="ui segment" style="width: 100%; border: 0 !important; padding-top: 0; text-align: center">
                    <input type="button" class="ui cancel  button" value="Hủy" />
                    <input type="submit" class="ui positive  button" value="Lưu" />
                </div>

                @*User ID, Post ID, Publish Date*@
                <div style="display: none">
                    @Html.EditorFor(model => model.Id)
                    @Html.EditorFor(model => model.UserId)
                    @Html.EditorFor(model => model.CreatedDate)                    
                </div>

            </div>

                                }
                                else
                                {
                                    <div class="ui segment">
                                        <div class="ui centered header">
                                            <i class="warning circle icon"></i>
                                            Trang bạn tìm kiếm đã bị xóa hoặc không tồn tại
                                        </div>
                                    </div>
                                    }

                                }
</div>
@*<script>
    function getAddressFromSearchBox() {
        // Create the search box and link it to the UI element.
    

        var input2 = document.getElementById("search-location2");
        var searchBox2 = new google.maps.places.SearchBox(input2);

        searchBox2.addListener('places_changed', function () {
            var places = searchBox2.getPlaces();
            if (places.length == 0) {
                return;
            }

            // For each place, get the icon, name and location.
            places.forEach(function (place) {
                document.getElementById("PostLocation_Address").value = place.name;
                document.getElementById("PostLocation_XCoordinate").value = place.geometry.location.lat();
                document.getElementById("PostLocation_YCoordinate").value = place.geometry.location.lng();

            });
        });
    }

    function getCurrentLocation2() {
        alert(3);
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
                var pos = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                
                var geocoder = new window.google.maps.Geocoder();             // create a geocoder object
                var location = new window.google.maps.LatLng(pos.lat, pos.lng);    // turn coordinates into an object          
                geocoder.geocode({ 'latLng': location }, function (results, status) {
                    if (status === window.google.maps.GeocoderStatus.OK) {           // if geocode success
                        var detailedLocation = results[0].formatted_address;         // if address found, pass to processing function
                        document.getElementById("PostLocation_Address").value = detailedLocation;
                        document.getElementById("PostLocation_XCoordinate").value = pos.lat;
                        document.getElementById("PostLocation_YCoordinate").value = pos.lng;
                    } else {
                    }
                })
            }, function () {
                // handleLocationError(true, myLocationMarker, map.getCenter());
                alert("Không thể định vị được vị trí của bạn. Bạn cần cho phép trình duyệt sử dụng định vị GPS.");
            });
        } else {
            // Browser doesn't support Geolocation
            //  handleLocationError(false, myLocationMarker, map.getCenter());
            alert("Trình duyệt của bạn không hỗ trợ định vị GPS. Vui lòng nâng cấp phiên bản mới nhất của trình duyệt và thử lại sau.");
        }
    }

    function getRegisteredLocation() {
        document.getElementById("PostLocation_Address").value = authenticatedUser.address;
        document.getElementById("PostLocation_XCoordinate").value = authenticatedUser.x;
        document.getElementById("PostLocation_YCoordinate").value = authenticatedUser.y;
    }
    $("getloc").click();

    google.maps.event.addDomListener(window, 'load', getAddressFromSearchBox);




</script>*@